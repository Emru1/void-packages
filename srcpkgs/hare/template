# Template file for 'hare'
pkgname=hare
version=0.24.2
revision=1
archs="x86_64 x86_64-musl aarch64 aarch64-musl riscv64 riscv64-musl"
build_style=configure
hostmakedepends="qbe harec scdoc"
depends="qbe harec"
short_desc="Systems programming language"
maintainer="Emil Tomczyk <emru@emru.xyz>"
license="MPL-2.0, GPL-3.0-only"
homepage="https://harelang.org/"
changelog="https://git.sr.ht/~sircmpwn/hare/refs"
distfiles="https://git.sr.ht/~sircmpwn/${pkgname}/archive/${version}.tar.gz"
checksum=afba69fd537a63442da53d115d9b50f525918159b395843ede2a5473323e0776

do_configure() {
	ARCH="${XBPS_TARGET_MACHINE%-musl}"
	case "${XBPS_TARGET_LIBC}" in
		"glibc") libc="gnu" ;;
		"musl") libc="musl" ;;
		*) exit 1
	esac

	case "${ARCH}" in
		"x86_64") qbe_target="amd64_sysv" ;;
		"aarch64") qbe_target="arm64" ;;
		"riscv64") qbe_target="rv64" ;;
		*) exit 1
	esac

	cp configs/linux.mk config.mk

	vsed -i config.mk -e "s|^PREFIX =.*$|PREFIX =/usr|"
	vsed -i config.mk -e "s|^ARCH =.*$|ARCH =${ARCH}|"

	vsed -i config.mk -e "/^AS/d"
	vsed -i config.mk -e "/^LD/d"

	vsed -i config.mk -e "s|^HARECFLAGS =.*$|HARECFLAGS = -a ${ARCH}|"
	vsed -i config.mk -e "s|^QBEFLAGS =.*$|QBEFLAGS = -t ${qbe_target}|"
}
